<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel Admin - TYQUÍNIS</title>
  <link rel="stylesheet" href="libs/css/bootstrap.min.css">
</head>
<body class="bg-light">
  <div class="container mt-4">
    <h2 class="text-center">Painel de Produtos</h2>
    <div class="text-end mb-3">
      <button class="btn btn-success" onclick="mostrarFormulario()">+ Novo Produto</button>
    </div>

    <div id="formulario" style="display:none;" class="mb-4">
      <h5 id="titulo-form">Adicionar Produto</h5>
      <form id="produto-form">
        <input type="text" class="form-control mb-2" placeholder="Nome" id="nome" required>
        <input type="text" class="form-control mb-2" placeholder="Descrição" id="descricao" required>
        <input type="number" class="form-control mb-2" placeholder="Valor" id="valor" required>
        <input type="text" class="form-control mb-2" placeholder="Tamanhos (ex: P,M,G)" id="tamanhos" required>
        <input type="text" class="form-control mb-2" placeholder="Cores (ex: Branca,Preta)" id="cores" required>

        <!-- CATEGORIA PADRONIZADA -->
        <select class="form-control mb-2" id="categoria" required>
          <option value="" disabled selected>Escolha a categoria</option>
          <option value="Biquinis">Biquinis</option>
          <option value="Acessórios">Acessórios</option>
          <option value="Kids">Kids</option>
          <option value="Plus Size">Plus Size</option>
        </select>

        <label for="upload-imagem" class="form-label">Imagem Principal</label>
<input type="file" class="form-control mb-3" id="upload-imagem">

<label for="outras-imagens" class="form-label">Demais Imagens (opcional)</label>
<input type="file" class="form-control mb-2" id="outras-imagens" multiple>

      <div class="d-grid gap-2">
        <button class="btn btn-primary" type="submit">Salvar Produto</button>
        <button class="btn btn-secondary" type="button" onclick="cancelarFormulario()">Cancelar</button>
      </div>

      </form>
    </div>

    <div id="lista-produtos" class="row g-3"></div>
  </div>

  <script>
    const token = localStorage.getItem('token');

// Verifica se o token existe e se ainda está válido
if (!token || isTokenExpirado(token)) {
  localStorage.removeItem('token');
  alert('Sua sessão expirou. Faça login novamente.');
  window.location.href = 'admin.html';
}

// Função para checar expiração do token
function isTokenExpirado(token) {
  try {
    const payloadBase64 = token.split('.')[1];
    const payload = JSON.parse(atob(payloadBase64));
    const agora = Math.floor(Date.now() / 1000);
    return payload.exp < agora;
  } catch (e) {
    return true; // se houver erro no token, trata como inválido
  }
}


    let modoEdicao = false;
    let idEditando = null;

    function mostrarFormulario() {
      document.getElementById('formulario').style.display = 'block';
      document.getElementById('titulo-form').textContent = 'Adicionar Produto';
    }

    function cancelarFormulario() {
  document.getElementById('produto-form').reset();
  document.getElementById('formulario').style.display = 'none';
  document.getElementById('titulo-form').textContent = 'Adicionar Produto';
  modoEdicao = false;
  idEditando = null;
}


async function carregarProdutos() {
  const res = await fetch('http://localhost:3000/produtos');
  const dados = await res.json();
  const container = document.getElementById('lista-produtos');
  container.innerHTML = '';

  const produtos = dados.produtos.slice().reverse(); // ⬅️ inverte a ordem
  produtos.forEach(produto => {
    const card = document.createElement('div');
    card.className = 'col-6 col-sm-6 col-md-6 col-lg-3 mb-4';
    card.innerHTML = `
      <div class="card p-2">
        <img src="${produto.imagemPerfil}" class="card-img-top" alt="${produto.nome}">
        <div class="card-body">
          <h5 class="card-title">${produto.nome}</h5>
          <p class="card-text">${produto.descricao}</p>
          <p class="card-text"><strong>R$ ${produto.valor.toFixed(2)}</strong></p>
          <button class="btn btn-warning btn-sm me-2" onclick="carregarParaEdicao('${produto.id}')">Editar</button>
          <button class="btn btn-danger btn-sm" onclick="excluirProduto('${produto.id}')">Excluir</button>
        </div>
      </div>
    `;
    container.appendChild(card);
  });
}


    async function excluirProduto(id) {
      if (!confirm("Tem certeza que deseja excluir?")) return;
      await fetch(`http://localhost:3000/produtos/${id}`, {
        method: 'DELETE',
        headers: { Authorization: token }
      });
      carregarProdutos();
    }

    function carregarParaEdicao(id) {
      fetch('http://localhost:3000/produtos')
        .then(res => res.json())
        .then(dados => {
          const produto = dados.produtos.find(p => p.id === id);
          if (!produto) return alert('Produto não encontrado');
          

          document.getElementById('nome').value = produto.nome;
          document.getElementById('descricao').value = produto.descricao;
          document.getElementById('valor').value = produto.valor;
          document.getElementById('tamanhos').value = produto.tamanhos.join(',');
          document.getElementById('cores').value = produto.cores.join(',');
          document.getElementById('categoria').value = produto.categoria;
          document.getElementById('formulario').style.display = 'block';
          document.getElementById('titulo-form').textContent = 'Editar Produto';
          document.getElementById('formulario').scrollIntoView({ behavior: 'smooth' });


          modoEdicao = true;
          idEditando = produto.id;
        });
    }

    async function enviarImagem(file) {
      const formData = new FormData();
      formData.append('imagem', file);

      const resposta = await fetch('http://localhost:3000/upload', {
        method: 'POST',
        headers: {
          Authorization: token
        },
        body: formData
      });

      const dados = await resposta.json();
      return dados.caminho;
    }

    document.getElementById('produto-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const arquivo = document.getElementById('upload-imagem').files[0];
      let imagemPerfil = '';

      if (arquivo) {
        imagemPerfil = await enviarImagem(arquivo);
      } else if (modoEdicao && idEditando) {
        const res = await fetch('http://localhost:3000/produtos');
        const dados = await res.json();
        const produtoOriginal = dados.produtos.find(p => p.id === idEditando);
        imagemPerfil = produtoOriginal?.imagemPerfil || '';
      }

      const novoProduto = {
        nome: document.getElementById('nome').value,
        descricao: document.getElementById('descricao').value,
        valor: parseFloat(document.getElementById('valor').value),
        tamanhos: document.getElementById('tamanhos').value.split(','),
        cores: document.getElementById('cores').value.split(','),
        categoria: document.getElementById('categoria').value,
        imagemPerfil,
        imagens: []
      };

      // Adiciona a imagem principal ao array, se houver
      if (imagemPerfil) {
        novoProduto.imagens.push(imagemPerfil);
      }

      // Upload das demais imagens
      const outrasImagens = document.getElementById('outras-imagens').files;
      for (let i = 0; i < outrasImagens.length; i++) {
        const caminho = await enviarImagem(outrasImagens[i]);
        novoProduto.imagens.push(caminho);
      }

      // Salva o produto
      if (modoEdicao) {
        await fetch(`http://localhost:3000/produtos/${idEditando}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            Authorization: token
          },
          body: JSON.stringify(novoProduto)
        });
        modoEdicao = false;
        idEditando = null;
      } else {
        await fetch('http://localhost:3000/produtos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: token
          },
          body: JSON.stringify(novoProduto)
        });
      }

      e.target.reset();
      document.getElementById('formulario').style.display = 'none';
      carregarProdutos();
    });

    carregarProdutos();
  </script>
</body>
</html>
